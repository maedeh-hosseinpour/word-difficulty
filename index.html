<!DOCTYPE html>
<html>
<head>
  <title>Word Difficulty Study - Introduction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px 10px;
      background: #fafafa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    #intro-task {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
      display: none; 
    }

    #welcome-screen {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }

    #welcome-screen p {
      font-size: clamp(14px, 4vw, 16px);
      color: #333;
      margin: 20px 10px;
      line-height: 1.4;
      max-width: 600px;
      text-align: left;
      margin-left: 80px;
      text-align: justify;
    }

    #start-training-btn {
      margin: 20px auto;
      padding: 16px 32px;
      font-size: 18px;
      cursor: pointer;
      border: 2px solid #ddd;
      border-radius: 6px;
      background-color: #fff;
      touch-action: manipulation;
      display: block;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    #start-training-btn:hover {
      background-color: #f5f5f5;
    }

    #word {
      width: 100%;
      max-width: 520px;
      min-height: 100px;
      margin: 20px auto;
      background: #fff;
      border: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 5px;
      font-size: clamp(32px, 8vw, 48px);
      padding: 20px 10px;
    }

    .word-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      line-height: 1.2;
    }

    .rating-button {
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 600;
      color: #555;
      padding: 12px 8px;
      margin: 6px 4px;
      min-width: 80px;
      cursor: pointer;
      border: solid 1px #e7e7e7;
      border-radius: 2px;
      background-color: #fff;
      transition: background-color 0.2s;
      flex: 1;
      max-width: 150px;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    #rating-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .rating-button:hover:not(:disabled) {
      background-color: #fafafa;
      border: solid 1px #ccc;
    }

    .rating-button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .rating-button.selected {
      background-color: #e0e0e0;
      border: solid 1px #999;
    }

    .letter.selectable {
      cursor: pointer;
      transition: color 0.2s, font-size 0.2s;
      touch-action: manipulation;
    }

    .letter.selectable:hover {
      color: rgb(20, 88, 197);
    }

    .letter.clicked {
      color: rgb(200, 17, 17);
    }

    #proceed-btn {
      margin: 20px auto;
      padding: 16px 32px;
      font-size: 18px;
      cursor: pointer;
      border: 2px solid #ddd;
      border-radius: 6px;
      background-color: #fff;
      touch-action: manipulation;
    }
    #proceed-btn:hover:not(:disabled) {
      background-color: #f5f5f5;
    }

    #proceed-btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    #rating-instruction {
      font-size: clamp(14px, 4vw, 17px);
      color: #555;
      margin: 15px 10px;
      line-height: 1.4;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .clear-text {
      cursor: pointer;
      color: #0066cc;
    }

    .clear-text:hover {
      color: #003366;
    }

    .clear-text.disabled {
      cursor: not-allowed;
      color: #999;
      pointer-events: none;
    }

    #text-explanation {
      display: none;
      margin: 25px 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      max-height: 40vh;
      overflow-y: auto;
    }

#difficultyReason {
      width: 100%;
      min-height: 120px;
      font-size: 16px;
      font-family: Arial, sans-serif;
      border: 1px solid #ddd  important;
      border-radius: 4px;
      padding: 12px;
      resize: vertical;
      line-height: 1.4;
    }

    .error-message {
      color: #d32f2f;
      font-size: clamp(12px, 3vw, 14px);
      margin: 10px;
      line-height: 1.4;
    }

    #char-count {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      text-align: right;
    }

    h1 {
      font-size: clamp(24px, 6vw, 32px);
      margin: 20px 10px;
      line-height: 1.3;
      color: #0066cc;
    }

    h2 {
      font-size: clamp(18px, 5vw, 24px);
      margin: 20px 10px;
      line-height: 1.3;
    }

    #instruction-message {
   font-size: 18px;
   color: #0066cc;
   margin: 10px 10px;
   line-height: 1.4;
   max-width: 600px;
   margin-left: auto;
   margin-right: auto;
   min-height: 50px; 
   display: flex;
   align-items: center;
   justify-content: center;
}

    @media (max-width: 768px) {
      body {
        padding: 10px 5px;
      }

      #intro-task, #welcome-screen {
        padding: 10px;
      }

      #word {
        margin: 15px auto;
        padding: 15px 5px;
      }

      .rating-button {
        min-width: 70px;
        padding: 10px 6px;
        margin: 4px 2px;
      }

      #rating-buttons {
        gap: 4px;
        padding: 0 5px;
      }

      #text-explanation {
        max-height: 20vh;
      }
    }

    @media (max-width: 480px) {
      .rating-button {
        font-size: 11px;
        padding: 8px 4px;
        min-width: 60px;
      }

      #rating-buttons {
        flex-direction: column;
        align-items: center;
      }

      .rating-button {
        max-width: 200px;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="welcome-screen">
    <h1>Welcome to the Word Difficulty Study</h1>
    <p id="welcome-message">
      You are going to rate the difficulty of reading some words.
      <br><br>
      This study includes three phases:<br><br>

      <b>1. Introduction (Training Phase):</b> 
      <br>You will begin by seeing three sample words: <i>sample 1, sample 2, sample 3.</i> Instructions will appear in blue at the top of the page. Please read and follow them carefully. This phase takes about 1â€“3 minutes.<br><br>

      <b>2. Main Study:</b> 
      <br> Using what you learned in the introduction, complete this phase <b>without taking a break</b>. For each word, rate it based on your current judgment.<br><br>

      <b>3. Analysis:</b> 
      <br>Once you've rated all the words, you will see which types of words are challenging for you to read. At the end, you will receive a 5-digit code. Please enter this code as your answer to the first question in the post-survey.
    </p>
    <br>
    <button id="start-training-btn" onclick="startTraining()">I am ready for the training mode</button>
  </div>

  <div id="intro-task">
    <h1>How this study works:</h1>
    <p id="instruction-message"></p>
    <h2 id="difficulty-question">What is your level of difficulty of reading this word?</h2>
    <div id="word"></div>

    <div id="rating-buttons">
      <button class="rating-button" data-rating="1" onclick="rateWord(1)">Very Easy (1)</button>
      <button class="rating-button" data-rating="2" onclick="rateWord(2)">Easy (2)</button>
      <button class="rating-button" data-rating="3" onclick="rateWord(3)">Hard (3)</button>
      <button class="rating-button" data-rating="4" onclick="rateWord(4)">Very Hard (4)</button>
    </div>

    <div id="rating-instruction" style="display: none;">
      Click the <b>letters</b> in the word above that you found hard to read. 
      <span id="clear" class="clear-text"><br>[clear letter selection]<br></span>
      <span id="no-letter-option" class="clear-text"><br>If there is no specific letter to select, click here to explain why<br></span>
    </div>

    <div id="text-explanation" style="display: none;">
      <textarea id="difficultyReason" placeholder="Please explain why you rated this word as you did (minimum 10 characters)." 
                oninput="checkProceedButtonState()" maxlength="500"></textarea>
      <div id="char-count">0/500 characters (minimum 10)</div>
    </div>

    <div id="error-container"></div>

    <div id="button-container">
      <button id="proceed-btn" onclick="goToNextWord()" disabled>Proceed to the next word</button>
    </div>
  </div>

  <script>
    const sampleWords = ["sample 1", "sample 2", "sample 3"];
    let currentIndex = 0;
    let currentPhase = "rating";
    let selectedRating = null;
    let clickedLetters = [];
    const MIN_EXPLANATION_LENGTH = 10;

    function startTraining() {
      document.getElementById("welcome-screen").style.display = "none";
      document.getElementById("intro-task").style.display = "block";
      showWord();
    }

    function updateInstructionMessage(message) {
      const instructionMessage = document.getElementById("instruction-message");
      instructionMessage.textContent = message;
    }

    function showWord() {
      const wordBox = document.getElementById("word");
      const instruction = document.getElementById("rating-instruction");
      const proceedBtn = document.getElementById("proceed-btn");
      const explanationBox = document.getElementById("text-explanation");
      const reasonInput = document.getElementById("difficultyReason");
      const errorContainer = document.getElementById("error-container");
      const noLetterOption = document.getElementById("no-letter-option");
      const clearLink = document.getElementById("clear");

      wordBox.innerHTML = "";
      wordBox.style.display = "flex";
      instruction.style.display = "none";
      proceedBtn.disabled = true;
      explanationBox.style.display = "none";
      reasonInput.value = "";
      errorContainer.innerHTML = "";
      clickedLetters = [];
      currentPhase = "rating";
      selectedRating = null;

      document.querySelectorAll(".rating-button").forEach(btn => {
        btn.classList.remove("selected");
        btn.disabled = false;
        btn.style.display = "inline-block";
      });

      if (currentIndex === 0) {
        document.querySelectorAll(".rating-button[data-rating='3'], .rating-button[data-rating='4']").forEach(btn => {
          btn.disabled = true;
        });
      } else {
        document.querySelectorAll(".rating-button[data-rating='1'], .rating-button[data-rating='2']").forEach(btn => {
          btn.disabled = true;
        });
      }

      if (noLetterOption) {
        noLetterOption.style.display = "inline";
        noLetterOption.classList.toggle("disabled", currentIndex === 1);
      }

      if (clearLink) {
        clearLink.classList.toggle("disabled", currentIndex === 2);
      }

      if (currentIndex < sampleWords.length) {
        const currentWord = sampleWords[currentIndex];
        const wordContainer = document.createElement("div");
        wordContainer.classList.add("word-container");

        [...currentWord].forEach((char, index) => {
          const span = document.createElement("span");
          span.textContent = char;
          span.classList.add("letter");
          span.dataset.index = index;
          wordContainer.appendChild(span);
        });

        wordBox.appendChild(wordContainer);

        updateInstructionMessage(currentIndex === 0
          ? "Please select 'Very Easy' or 'Easy' by clicking a button or pressing 1 or 2."
          : "Please select 'Hard' or 'Very Hard' by clicking a button or pressing 3 or 4.");
      } else {
        document.getElementById("proceed-btn").textContent = "I am ready for the study";
        wordBox.style.display = "none";
        document.getElementById("rating-buttons").style.display = "none";
        document.getElementById("rating-instruction").style.display = "none";
        document.getElementById("text-explanation").style.display = "none";
        document.getElementById("difficulty-question").style.display = "none";
        updateInstructionMessage("You are ready to start the study. Click 'I am ready for the study' to proceed.");
      }
    }

    function rateWord(rating) {
      selectedRating = rating;
      document.querySelectorAll(".rating-button").forEach(btn => {
        btn.classList.remove("selected");
        if (parseInt(btn.dataset.rating) === rating) {
          btn.classList.add("selected");
        }
      });

      if (currentIndex === 0) {
        if (rating === 1 || rating === 2) {
          document.getElementById("text-explanation").style.display = "block";
          document.getElementById("rating-instruction").style.display = "none";
          document.getElementById("proceed-btn").disabled = false;
          updateInstructionMessage("You may optionally provide an explanation in the text box below, or click 'Proceed to the next word'.");
          currentPhase = "text-explanation";
        } else {
          document.getElementById("text-explanation").style.display = "block";
          document.getElementById("rating-instruction").style.display = "none";
          updateInstructionMessage("Please explain why you rated this word as you did in the text box below.");
          currentPhase = "text-explanation";
        }
      } else {
        document.getElementById("rating-instruction").style.display = "block";
        document.getElementById("text-explanation").style.display = currentIndex === 2 ? "none" : "none";
        updateInstructionMessage(currentIndex === 1
          ? "Please click on the letters you found hard to read."
          : "Please click on the letters you found hard to read, or click 'If there is no specific letter to select, click here to explain why'.");
        if (currentIndex !== 2) {
          enableLetterSelection();
          currentPhase = "letter-selection";
        } else {
          enableLetterSelection();
          currentPhase = "letter-selection";
        }
      }
      checkProceedButtonState();
    }

    function enableLetterSelection() {
      const letters = document.querySelectorAll("#word .letter");
      letters.forEach(span => {
        if (currentIndex !== 2) { 
          span.classList.add("selectable");
          span.onclick = () => {
            const idx = parseInt(span.dataset.index);
            if (span.classList.contains("clicked")) {
              span.classList.remove("clicked");
              clickedLetters = clickedLetters.filter(l => l.position !== idx);
            } else {
              span.classList.add("clicked");
              clickedLetters.push({ letter: span.textContent, position: idx });
            }
            checkProceedButtonState();
            if (clickedLetters.length > 0) {
              updateInstructionMessage("The 'Proceed to the next word' button is now active. Click it to continue.");
            }
          };
        }
      });

      const clearLink = document.getElementById("clear");
      if (clearLink && currentIndex !== 2) {
        clearLink.onclick = resetLetterSelection;
      }

      const noLetterOption = document.getElementById("no-letter-option");
      if (noLetterOption) {
        noLetterOption.onclick = () => {
          currentPhase = "text-explanation";
          document.getElementById("text-explanation").style.display = "block";
          document.getElementById("difficultyReason").value = "";
          updateCharCount();
          checkProceedButtonState();
          updateInstructionMessage("Please explain why you rated this word as " + (selectedRating === 3 ? "'Hard'" : "'Very Hard'") + " in the text box below.");
        };
      }
    }

    function resetLetterSelection() {
      if (currentIndex === 2) return; 
      const letters = document.querySelectorAll("#word .letter");
      letters.forEach(span => span.classList.remove("clicked"));
      clickedLetters = [];
      document.getElementById("text-explanation").style.display = "none";
      document.getElementById("difficultyReason").value = "";
      currentPhase = "letter-selection";
      checkProceedButtonState();
      if (currentIndex === 1) {
        updateInstructionMessage("Please click on the letters you found hard to read.");
      }
    }

    function updateCharCount() {
      const reasonText = document.getElementById("difficultyReason").value;
      const charCount = document.getElementById("char-count");
      const remaining = 500 - reasonText.length;
      const isValid = reasonText.length >= MIN_EXPLANATION_LENGTH;
      charCount.textContent = `${reasonText.length}/500 characters (minimum ${MIN_EXPLANATION_LENGTH})`;
      charCount.style.color = isValid ? "#2e7d32" : "#666";
    }

    function checkProceedButtonState() {
      const proceedBtn = document.getElementById("proceed-btn");
      const reasonText = document.getElementById("difficultyReason").value.trim();
      const hasExplanation = reasonText.length >= MIN_EXPLANATION_LENGTH;
      const hasLetterSelections = clickedLetters.length > 0;

      if (currentIndex === 0) {
        proceedBtn.disabled = selectedRating === null;
      } else if (currentIndex === 1) {
        proceedBtn.disabled = !hasLetterSelections;
      } else {
        proceedBtn.disabled = !hasExplanation && !hasLetterSelections;
      }
      updateCharCount();
    }

    function showError(message) {
      const errorContainer = document.getElementById("error-container");
      errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function goToNextWord() {
      const reasonText = document.getElementById("difficultyReason").value.trim();
      if (currentIndex === 0 && selectedRating !== 1 && selectedRating !== 2 && reasonText.length < MIN_EXPLANATION_LENGTH) {
        showError(`Please provide at least ${MIN_EXPLANATION_LENGTH} characters of explanation.`);
        return;
      } else if (currentIndex === 1 && clickedLetters.length === 0) {
        showError(`Please select at least one letter.`);
        return;
      } else if (currentIndex === 2 && reasonText.length < MIN_EXPLANATION_LENGTH && clickedLetters.length === 0) {
        showError(`Please select at least one letter or provide at least ${MIN_EXPLANATION_LENGTH} characters of explanation.`);
        return;
      }

      currentIndex++;
      if (currentIndex < sampleWords.length) {
        showWord();
      } else {
        document.getElementById("proceed-btn").textContent = "I am ready for the study";
        document.getElementById("word").style.display = "none";
        document.getElementById("rating-buttons").style.display = "none";
        document.getElementById("rating-instruction").style.display = "none";
        document.getElementById("text-explanation").style.display = "none";
        document.getElementById("difficulty-question").style.display = "none";
        updateInstructionMessage("You are ready to start the study. Click 'I am ready for the study' to proceed.");
        document.getElementById("proceed-btn").onclick = () => {
          sessionStorage.setItem("introCompleted", "true");
          window.location.href = "main.html";
        };
      }
    }

    document.addEventListener('keydown', (event) => {
      const key = event.key;
      if (key === 'Enter' && !document.getElementById("proceed-btn").disabled && document.getElementById("intro-task").style.display === "block") {
        if (event.target.tagName === 'TEXTAREA') return;
        event.preventDefault();
        goToNextWord();
      } else if (['1', '2', '3', '4'].includes(key) && document.getElementById("intro-task").style.display === "block") {
        if (event.target.tagName === 'TEXTAREA') return;
        event.preventDefault();
        const rating = parseInt(key);
        if (currentIndex === 0 && (rating === 1 || rating === 2)) {
          rateWord(rating);
        } else if (currentIndex > 0 && (rating === 3 || rating === 4)) {
          rateWord(rating);
        }
      } else if (key === 'Enter' && document.getElementById("welcome-screen").style.display === "block") {
        event.preventDefault();
        startTraining();
      }
    });

    document.getElementById("difficultyReason").addEventListener('input', checkProceedButtonState);
  </script>
</body>
</html>